<script>
    // ########## KONFIGURASI ##########
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSnscGjeA3LpLsZovKlVR6oijcOuTLz2q6oysk9bo/exec';
    // #################################

    // Pembolehubah Global
    let allData = [];
    let studentNames = [];

    // Rujukan Elemen DOM
    const studentSelect = document.getElementById('studentSelect');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const selectionSection = document.getElementById('selectionSection');
    const resultsSection = document.getElementById('resultsSection');
    const errorMessage = document.getElementById('errorMessage');
    const backBtn = document.getElementById('backBtn');
    const printArea = document.getElementById('print-area');

    // Fungsi untuk mengambil data dari Google Script
    async function fetchData(action, params = {}) {
        const url = new URL(GOOGLE_SCRIPT_URL);
        url.searchParams.append('action', action);
        for (const key in params) {
            url.searchParams.append(key, params[key]);
        }
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Ralat rangkaian: ${response.statusText}`);
            }
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
            return data;
        } catch (error) {
            console.error('Ralat semasa mengambil data:', error);
            showError(error.message);
            throw error; // Lemparkan semula ralat untuk ditangkap oleh fungsi pemanggil
        }
    }

    // Inisialisasi Aplikasi
    async function init() {
        showLoading(true, 'Sedang memuatkan senarai pelajar...');
        try {
            studentNames = await fetchData('getStudentNames');
            populateStudentDropdown();
        } catch (error) {
            // Ralat sudah ditunjukkan oleh fetchData
        } finally {
            showLoading(false);
        }
    }

    // Memuatkan nama pelajar ke dalam dropdown
    function populateStudentDropdown() {
        studentSelect.innerHTML = '<option value="">-- Pilih nama anda --</option>';
        studentNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            studentSelect.appendChild(option);
        });
    }

    // Memuatkan data prestasi pelajar yang dipilih
    async function loadStudentData(studentName) {
        showLoading(true, 'Sedang memuatkan prestasi...');
        try {
            const data = await fetchData('getStudentData', { name: studentName });
            allData = data;
            displayStudentResults(studentName, data);
        } catch (error) {
            // Ralat sudah ditunjukkan oleh fetchData
        } finally {
            showLoading(false);
        }
    }
    
    // Memaparkan keputusan pelajar
    function displayStudentResults(studentName, data) {
        document.getElementById('selectedStudentName').textContent = studentName;
        
        // Kemas kini kad ringkasan
        document.getElementById('totalTournaments').textContent = data.length;
        
        const sortedByDate = [...data].sort((a, b) => new Date(b['Date/Tarikh']) - new Date(a['Date/Tarikh']));
        
        document.getElementById('bestAchievement').textContent = findBestAchievement(data) || '-';
        document.getElementById('latestTournament').textContent = sortedByDate[0]?.['Tournament Name/Nama Kejohanan'] || '-';
        
        // Sediakan penapis dan paparkan senarai
        setupFilters(data);
        displayAchievements(sortedByDate);
        
        // Tukar paparan
        selectionSection.classList.add('hidden');
        resultsSection.classList.remove('hidden');
    }
    
    // Mencari pencapaian terbaik
    function findBestAchievement(data) {
        if (data.length === 0) return null;
        const ranking = { 'johan': 1, 'naib johan': 2, 'tempat ke 3': 3 };
        let best = { achievement: data[0]['Achievement/Pencapaian'], rank: 99 };
    
        data.forEach(item => {
            const achievementText = item['Achievement/Pencapaian'].toLowerCase();
            let currentRank = 99;
    
            for (const key in ranking) {
                if (achievementText.includes(key)) {
                    currentRank = ranking[key];
                    break;
                }
            }
    
            if (currentRank < best.rank) {
                best = { achievement: item['Achievement/Pencapaian'], rank: currentRank };
            }
        });
        return best.achievement;
    }

    // Mencipta kad pencapaian individu
    function createAchievementCard(record) {
        const card = document.createElement('div');
        card.className = 'bg-orange-50 border border-orange-200 rounded-lg p-4 hover:shadow-md transition duration-300';
        
        const achievementColor = getAchievementColor(record['Achievement/Pencapaian']);
        
        card.innerHTML = `
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-orange-800 mb-2">${record['Tournament Name/Nama Kejohanan']}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                        <p><span class="font-medium">Tarikh:</span> ${formatDate(record['Date/Tarikh'])}</p>
                        <p><span class="font-medium">Peringkat:</span> ${record['Level/Peringkat']}</p>
                        <p><span class="font-medium">Kategori:</span> ${record['Category/Kategori']}</p>
                        <p><span class="font-medium">Pencapaian:</span> 
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${achievementColor}">
                                ${record['Achievement/Pencapaian']}
                            </span>
                        </p>
                    </div>
                    ${record['Remarks/Tambahan'] ? `<p class="text-sm text-orange-600 mt-2 italic">Catatan: ${record['Remarks/Tambahan']}</p>` : ''}
                </div>
                ${record['URL Photo'] ? `
                    <div class="mt-4 md:mt-0 md:ml-4">
                        <button onclick="viewPhoto('${record['URL Photo']}')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition duration-300">
                            ðŸ“· Lihat Gambar
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
        return card;
    }
    
    // Fungsi bantuan lain (tidak berubah, tetapi disertakan untuk kelengkapan)
    function getAchievementColor(achievement) {
        const ach = (achievement || '').toLowerCase();
        if (ach.includes('johan')) return 'bg-yellow-100 text-yellow-800';
        if (ach.includes('naib johan')) return 'bg-gray-100 text-gray-800';
        if (ach.includes('tempat ke 3')) return 'bg-orange-100 text-orange-800';
        return 'bg-blue-100 text-blue-800';
    }

    function formatDate(dateString) {
        if (!dateString) return 'Tiada Tarikh';
        const date = new Date(dateString);
        if (isNaN(date)) return dateString; // Pulangkan string asal jika tarikh tidak sah
        return date.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function showLoading(show, message = 'Memuat data...') {
        const loadingText = loadingIndicator.querySelector('p');
        if (loadingText) loadingText.textContent = message;
        loadingIndicator.classList.toggle('hidden', !show);
        loadDataBtn.disabled = show;
        studentSelect.disabled = show;
    }

    function showError(message) {
        document.getElementById('errorText').textContent = message;
        errorMessage.classList.remove('hidden');
        setTimeout(() => errorMessage.classList.add('hidden'), 5000);
    }
    
    function viewPhoto(url) {
        const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/) || url.match(/id=([a-zA-Z0-9-_]+)/);
        if (fileIdMatch) {
            const fileId = fileIdMatch[1];
            const directUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.onclick = () => modal.remove();
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full bg-white rounded-lg overflow-hidden">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center z-10">âœ•</button>
                    <img src="${directUrl}" alt="Gambar Pencapaian" class="max-w-full max-h-screen object-contain" onerror="this.parentElement.innerHTML='<div class=\\'p-8 text-center\\'>Tidak dapat memuat gambar. <br><a href=\\'${url}\\' target=\\'_blank\\' class=\\'text-blue-500 underline\\'>Buka di Google Drive</a></div>'">
                </div>`;
            document.body.appendChild(modal);
        } else if (url) {
            window.open(url, '_blank');
        }
    }
    
    // Logik Penapis (Filters)
    function setupFilters(data) {
        const createButtons = (containerId, items, key, type) => {
            const container = document.getElementById(containerId);
            container.innerHTML = `<button data-value="all" class="filter-btn active bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700 transition duration-300">Semua</button>`;
            [...new Set(items.map(item => item[key]))].forEach(value => {
                if (!value) return;
                const button = document.createElement('button');
                button.dataset.value = value;
                button.className = 'filter-btn bg-orange-200 text-orange-800 px-3 py-1 rounded text-sm hover:bg-orange-300 transition duration-300';
                button.textContent = value;
                container.appendChild(button);
            });
            container.onclick = (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    filterAchievements(type, e.target.dataset.value);
                }
            };
        };
        createButtons('categoryFilters', data, 'Category/Kategori', 'category');
        createButtons('levelFilters', data, 'Level/Peringkat', 'level');
        resetFilters();
    }
    
    let currentFilters = { category: 'all', level: 'all' };

    function filterAchievements(type, value) {
        currentFilters[type] = value;
        
        document.querySelectorAll(`#${type}Filters .filter-btn`).forEach(btn => {
            const isActive = btn.dataset.value === value;
            btn.className = `filter-btn px-3 py-1 rounded text-sm transition duration-300 ${isActive ? 'active bg-orange-600 text-white hover:bg-orange-700' : 'bg-orange-200 text-orange-800 hover:bg-orange-300'}`;
        });
        
        const filtered = allData.filter(record => 
            (currentFilters.category === 'all' || record['Category/Kategori'] === currentFilters.category) &&
            (currentFilters.level === 'all' || record['Level/Peringkat'] === currentFilters.level)
        );
        
        displayAchievements(filtered.sort((a, b) => new Date(b['Date/Tarikh']) - new Date(a['Date/Tarikh'])));
    }
    
    function resetFilters() {
        filterAchievements('category', 'all');
        filterAchievements('level', 'all');
    }

    function displayAchievements(data) {
        const list = document.getElementById('achievementsList');
        list.innerHTML = '';
        if (data.length === 0) {
            list.innerHTML = `<div class="text-center py-8 text-gray-500"><p class="text-lg">Tiada pencapaian ditemui untuk tapisan ini.</p></div>`;
            return;
        }
        data.forEach(record => list.appendChild(createAchievementCard(record)));
    }
    
    // Event Listeners
    studentSelect.addEventListener('change', function() {
        loadDataBtn.disabled = this.value === '';
    });

    loadDataBtn.addEventListener('click', function() {
        if (studentSelect.value) loadStudentData(studentSelect.value);
    });

    backBtn.addEventListener('click', function() {
        resultsSection.classList.add('hidden');
        selectionSection.classList.remove('hidden');
        studentSelect.value = '';
        loadDataBtn.disabled = true;
    });
    
    document.getElementById('downloadPdfBtn').addEventListener('click', () => {
        window.print();
    });

    // Mulakan aplikasi
    document.addEventListener('DOMContentLoaded', init);
</script>

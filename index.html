<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Prestasi Pelajar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menambah stail untuk cetakan PDF */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'orange': { 50: '#fff7ed', 100: '#ffedd5', 200: '#fed7aa', 300: '#fdba74', 400: '#fb923c', 500: '#f97316', 600: '#ea580c', 700: '#c2410c', 800: '#9a3412', 900: '#7c2d12' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-orange-100 min-h-screen">
    <header class="bg-orange-600 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-3xl font-bold text-center">Portal Prestasi Pelajar</h1>
            <p class="text-center text-orange-100 mt-2">Lihat pencapaian dan prestasi anda</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div id="selectionSection" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-orange-800 mb-4 text-center">Pilih Nama Anda</h2>
            
            <div class="mb-4">
                <label for="studentSelect" class="block text-sm font-medium text-orange-700 mb-2">
                    Nama Pelajar:
                </label>
                <select id="studentSelect" class="w-full px-3 py-2 border border-orange-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="">-- Sedang memuatkan nama... --</option>
                </select>
            </div>

            <button id="loadDataBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-md transition duration-300 disabled:bg-orange-300 disabled:cursor-not-allowed" disabled>
                Paparkan Prestasi
            </button>

            <div id="loadingIndicator" class="hidden text-center mt-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>
                <p class="text-orange-600 mt-2">Memuat data...</p>
            </div>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4 flex-wrap">
                    <h2 class="text-2xl font-semibold text-orange-800">Prestasi: <span id="selectedStudentName" class="text-orange-600"></span></h2>
                    <button id="backBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md transition duration-300 mt-2 sm:mt-0">
                        Kembali
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                        <h3 class="text-lg font-semibold text-orange-800">Jumlah Kejohanan</h3>
                        <p id="totalTournaments" class="text-3xl font-bold text-orange-600">0</p>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                        <h3 class="text-lg font-semibold text-orange-800">Pencapaian Terbaik</h3>
                        <p id="bestAchievement" class="text-xl font-bold text-orange-600">-</p>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                        <h3 class="text-lg font-semibold text-orange-800">Kejohanan Terkini</h3>
                        <p id="latestTournament" class="text-sm font-semibold text-orange-600">-</p>
                    </div>
                </div>

                <div class="mb-6 bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-orange-800 mb-3">Tapis Pencapaian</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-orange-700 mb-2">Kategori:</label>
                        <div id="categoryFilters" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-orange-700 mb-2">Peringkat:</label>
                        <div id="levelFilters" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="mb-6 bg-gradient-to-r from-orange-50 to-orange-100 border border-orange-200 rounded-lg p-4">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div>
                            <h3 class="text-lg font-semibold text-orange-800">ðŸ“„ Laporan Pencapaian</h3>
                            <p class="text-sm text-orange-600">Cetak atau simpan laporan lengkap dalam format PDF</p>
                        </div>
                        <button id="downloadPdfBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-300 flex items-center gap-2 shadow-md">
                            ðŸ“„ Cetak Laporan
                        </button>
                    </div>
                </div>

                <div id="achievementsList" class="space-y-4"></div>
            </div>
        </div>

        <div id="errorMessage" class="hidden max-w-md mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md">
            <p class="font-semibold">Ralat!</p>
            <p id="errorText">Tidak dapat memuat data. Sila cuba lagi.</p>
        </div>
    </main>

    <div id="print-area" class="hidden"></div>
    
    <script>
        // ########## KONFIGURASI ##########
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwSnscGjeA3LpLsZovKlVR6oijcOuTLz2q6oysk9bo/exec';
        // #################################

        // Pembolehubah Global
        let allData = [];
        let studentNames = [];

        // Rujukan Elemen DOM
        const studentSelect = document.getElementById('studentSelect');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const selectionSection = document.getElementById('selectionSection');
        const resultsSection = document.getElementById('resultsSection');
        const errorMessage = document.getElementById('errorMessage');
        const backBtn = document.getElementById('backBtn');
        const printArea = document.getElementById('print-area');

        // Fungsi untuk mengambil data dari Google Script
        async function fetchData(action, params = {}) {
            const url = new URL(GOOGLE_SCRIPT_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Ralat rangkaian: ${response.statusText}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                return data;
            } catch (error) {
                console.error('Ralat semasa mengambil data:', error);
                showError(error.message);
                throw error;
            }
        }

        // Inisialisasi Aplikasi
        async function init() {
            showLoading(true, 'Sedang memuatkan senarai pelajar...');
            try {
                studentNames = await fetchData('getStudentNames');
                populateStudentDropdown();
            } catch (error) {
                // Ralat sudah ditunjukkan oleh fetchData
            } finally {
                showLoading(false);
            }
        }

        // Memuatkan nama pelajar ke dalam dropdown
        function populateStudentDropdown() {
            studentSelect.innerHTML = '<option value="">-- Pilih nama anda --</option>';
            studentNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                studentSelect.appendChild(option);
            });
        }

        // Memuatkan data prestasi pelajar yang dipilih
        async function loadStudentData(studentName) {
            showLoading(true, 'Sedang memuatkan prestasi...');
            try {
                const data = await fetchData('getStudentData', { name: studentName });
                allData = data;
                displayStudentResults(studentName, data);
            } catch (error) {
                // Ralat sudah ditunjukkan oleh fetchData
            } finally {
                showLoading(false);
            }
        }
        
        // Memaparkan keputusan pelajar
        function displayStudentResults(studentName, data) {
            document.getElementById('selectedStudentName').textContent = studentName;
            
            document.getElementById('totalTournaments').textContent = data.length;
            
            const sortedByDate = [...data].sort((a, b) => new Date(b['Date/Tarikh']) - new Date(a['Date/Tarikh']));
            
            document.getElementById('bestAchievement').textContent = findBestAchievement(data) || '-';
            document.getElementById('latestTournament').textContent = sortedByDate[0]?.['Tournament Name/Nama Kejohanan'] || '-';
            
            setupFilters(data);
            displayAchievements(sortedByDate);
            
            selectionSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
        }
        
        // Mencari pencapaian terbaik
        function findBestAchievement(data) {
            if (data.length === 0) return null;
            const ranking = { 'johan': 1, 'best girl': 1.5, 'naib johan': 2, 'tempat ke 3': 3 };
            let best = { achievement: data[0]['Achievement/Pencapaian'], rank: 99 };
        
            data.forEach(item => {
                const achievementText = (item['Achievement/Pencapaian'] || '').toLowerCase();
                let currentRank = 99;
        
                for (const key in ranking) {
                    if (achievementText.includes(key)) {
                        currentRank = ranking[key];
                        break;
                    }
                }
        
                if (currentRank < best.rank) {
                    best = { achievement: item['Achievement/Pencapaian'], rank: currentRank };
                }
            });
            return best.achievement;
        }

        // Mencipta kad pencapaian individu
        function createAchievementCard(record) {
            const card = document.createElement('div');
            card.className = 'bg-orange-50 border border-orange-200 rounded-lg p-4 hover:shadow-md transition duration-300';
            
            const achievementColor = getAchievementColor(record['Achievement/Pencapaian']);
            
            card.innerHTML = `
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-orange-800 mb-2">${record['Tournament Name/Nama Kejohanan']}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                            <p><span class="font-medium">Tarikh:</span> ${formatDate(record['Date/Tarikh'])}</p>
                            <p><span class="font-medium">Peringkat:</span> ${record['Level/Peringkat']}</p>
                            <p><span class="font-medium">Kategori:</span> ${record['Category/Kategori']}</p>
                            <p><span class="font-medium">Pencapaian:</span> 
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${achievementColor}">
                                    ${record['Achievement/Pencapaian']}
                                </span>
                            </p>
                        </div>
                        ${record['Remarks/Tambahan'] ? `<p class="text-sm text-orange-600 mt-2 italic">Catatan: ${record['Remarks/Tambahan']}</p>` : ''}
                    </div>
                    ${record['URL Photo'] ? `
                        <div class="mt-4 md:mt-0 md:ml-4">
                            <button onclick="viewPhoto('${record['URL Photo']}')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition duration-300">
                                ðŸ“· Lihat Gambar
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            return card;
        }
        
        function getAchievementColor(achievement) {
            const ach = (achievement || '').toLowerCase();
            if (ach.includes('johan') || ach.includes('best girl')) return 'bg-yellow-100 text-yellow-800';
            if (ach.includes('naib johan')) return 'bg-gray-100 text-gray-800';
            if (ach.includes('tempat ke 3')) return 'bg-orange-100 text-orange-800';
            return 'bg-blue-100 text-blue-800';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Tiada Tarikh';
            const date = new Date(dateString);
            if (isNaN(date)) return dateString;
            return date.toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function showLoading(show, message = 'Memuat data...') {
            loadingIndicator.querySelector('p').textContent = message;
            loadingIndicator.classList.toggle('hidden', !show);
            loadDataBtn.disabled = show;
            studentSelect.disabled = show;
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }
        
        function viewPhoto(url) {
            const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/) || url.match(/id=([a-zA-Z0-9-_]+)/);
            if (fileIdMatch && fileIdMatch[1]) {
                const directUrl = `https://drive.google.com/uc?export=view&id=${fileIdMatch[1]}`;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                modal.onclick = () => modal.remove();
                modal.innerHTML = `
                    <div class="relative max-w-4xl max-h-full bg-white rounded-lg overflow-hidden">
                        <button onclick="this.parentElement.parentElement.remove()" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center z-10">âœ•</button>
                        <img src="${directUrl}" alt="Gambar Pencapaian" class="max-w-full max-h-screen object-contain" onerror="this.parentElement.innerHTML='<div class=\\'p-8 text-center\\'>Tidak dapat memuat gambar. <br><a href=\\'${url}\\' target=\\'_blank\\' class=\\'text-blue-500 underline\\'>Buka di Google Drive</a></div>'">
                    </div>`;
                document.body.appendChild(modal);
            } else if (url) {
                window.open(url, '_blank');
            }
        }
        
        function setupFilters(data) {
            const createButtons = (containerId, items, key, type) => {
                const container = document.getElementById(containerId);
                container.innerHTML = `<button data-value="all" class="filter-btn active bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700 transition duration-300">Semua</button>`;
                [...new Set(items.map(item => item[key]))].forEach(value => {
                    if (!value) return;
                    const button = document.createElement('button');
                    button.dataset.value = value;
                    button.className = 'filter-btn bg-orange-200 text-orange-800 px-3 py-1 rounded text-sm hover:bg-orange-300 transition duration-300';
                    button.textContent = value;
                    container.appendChild(button);
                });
                container.onclick = (e) => {
                    if (e.target.classList.contains('filter-btn')) {
                        filterAchievements(type, e.target.dataset.value);
                    }
                };
            };
            createButtons('categoryFilters', data, 'Category/Kategori', 'category');
            createButtons('levelFilters', data, 'Level/Peringkat', 'level');
            resetFilters();
        }
        
        let currentFilters = { category: 'all', level: 'all' };

        function filterAchievements(type, value) {
            currentFilters[type] = value;
            document.querySelectorAll(`#${type}Filters .filter-btn`).forEach(btn => {
                const isActive = btn.dataset.value === value;
                btn.className = `filter-btn px-3 py-1 rounded text-sm transition duration-300 ${isActive ? 'active bg-orange-600 text-white hover:bg-orange-700' : 'bg-orange-200 text-orange-800 hover:bg-orange-300'}`;
            });
            const filtered = allData.filter(record => 
                (currentFilters.category === 'all' || record['Category/Kategori'] === currentFilters.category) &&
                (currentFilters.level === 'all' || record['Level/Peringkat'] === currentFilters.level)
            );
            displayAchievements(filtered.sort((a, b) => new Date(b['Date/Tarikh']) - new Date(a['Date/Tarikh'])));
        }
        
        function resetFilters() {
            filterAchievements('category', 'all');
            filterAchievements('level', 'all');
        }

        function displayAchievements(data) {
            const list = document.getElementById('achievementsList');
            list.innerHTML = '';
            if (data.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-gray-500"><p class="text-lg">Tiada pencapaian ditemui untuk tapisan ini.</p></div>`;
                return;
            }
            data.forEach(record => list.appendChild(createAchievementCard(record)));
        }
        
        function generatePrintContent(studentName, data) {
            const currentDate = new Date().toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' });
            const sortedData = [...data].sort((a, b) => new Date(b['Date/Tarikh']) - new Date(a['Date/Tarikh']));
            const total = data.length;
            const best = findBestAchievement(data);
            
            return `<!DOCTYPE html><html><head><title>Laporan Prestasi - ${studentName}</title>
                <style>body{font-family:Arial,sans-serif;color:#333} .header{text-align:center;border-bottom:2px solid #ea580c;padding-bottom:15px;margin-bottom:20px} h1{color:#ea580c;margin:0} h2{color:#9a3412;margin:5px 0 0} table{width:100%;border-collapse:collapse;margin-top:20px} th,td{border:1px solid #ddd;padding:8px;text-align:left} th{background-color:#fff7ed;color:#9a3412} tr:nth-child(even){background-color:#f9fafb} .footer{margin-top:30px;text-align:center;font-size:12px;color:#6b7280; page-break-before: auto;}</style>
                </head><body><div class="header"><h1>LAPORAN PRESTASI PELAJAR</h1><h2>${studentName}</h2><p>Tarikh Laporan: ${currentDate}</p></div>
                <h3>Ringkasan</h3><p><strong>Jumlah Kejohanan:</strong> ${total}</p><p><strong>Pencapaian Terbaik:</strong> ${best}</p>
                <h3>Senarai Pencapaian</h3>
                <table><thead><tr><th>Bil.</th><th>Kejohanan</th><th>Tarikh</th><th>Peringkat</th><th>Kategori</th><th>Pencapaian</th></tr></thead>
                <tbody>${sortedData.map((r, i) => `<tr><td>${i+1}</td><td>${r['Tournament Name/Nama Kejohanan']}</td><td>${formatDate(r['Date/Tarikh'])}</td><td>${r['Level/Peringkat']}</td><td>${r['Category/Kategori']}</td><td>${r['Achievement/Pencapaian']}</td></tr>`).join('')}
                </tbody></table><div class="footer"><p>Laporan ini dijana secara automatik dari Portal Prestasi Pelajar.</p></div></body></html>`;
        }
        
        // Event Listeners
        studentSelect.addEventListener('change', () => {
            loadDataBtn.disabled = studentSelect.value === '';
        });

        loadDataBtn.addEventListener('click', () => {
            if (studentSelect.value) loadStudentData(studentSelect.value);
        });

        backBtn.addEventListener('click', () => {
            resultsSection.classList.add('hidden');
            selectionSection.classList.remove('hidden');
            studentSelect.value = '';
            loadDataBtn.disabled = true;
        });
        
        document.getElementById('downloadPdfBtn').addEventListener('click', () => {
            const studentName = document.getElementById('selectedStudentName').textContent;
            printArea.innerHTML = generatePrintContent(studentName, allData);
            window.print();
        });

        // Mulakan aplikasi
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
